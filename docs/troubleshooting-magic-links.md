# Troubleshooting Magic Link Authentication

## Issue: Magic Link Uses Wrong Redirect URL

If you're seeing magic links with `http://localhost:3000` instead of your tunnel URL, here are the steps to fix it:

### 1. Check Generated URL in Console

First, check what URL is being generated by looking at the console logs when you try to sign in. You should see:

```
=== MAGIC LINK DEBUG ===
Generated redirect URL: exp://u3m58lo-serendipitytech-8081.exp.direct/auth/callback
```

If you see `http://localhost:3000`, the issue is likely in your Supabase dashboard configuration.

### 2. Check Supabase Dashboard Configuration

#### A. Site URL Configuration
1. Go to your Supabase project dashboard
2. Navigate to **Authentication > URL Configuration**
3. Check the **Site URL** field
   - ❌ **Wrong**: `http://localhost:3000`
   - ✅ **Correct**: Your production domain or leave empty for development

#### B. Redirect URLs
Make sure these URLs are in your **Redirect URLs** list:
```
exp://127.0.0.1:8081/auth/callback
exp://u3m58lo-serendipitytech-8081.exp.direct/auth/callback
expo-checkin://auth/callback
```

#### C. Remove Conflicting URLs
If you have `http://localhost:3000` in your redirect URLs list, **remove it** as it might be taking precedence.

### 3. Clear Supabase Client Cache

The Supabase client might be cached with old configuration. Try:

```typescript
import { clearSupabaseClient } from './services/supabase';

// Clear the cached client
clearSupabaseClient();
```

### 4. Verify Environment Variables

Make sure your `.env` file has the correct Supabase credentials:

```bash
EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### 5. Test URL Generation

Add this test to your app to verify URL generation:

```typescript
import { testAuthUrlGeneration } from './utils/testAuth';

// Call this function to test URL generation
testAuthUrlGeneration();
```

### 6. Common Issues and Solutions

#### Issue: "Safari can't open page because it couldn't connect to the server"
**Cause**: Magic link is using `http://localhost:3000` instead of tunnel URL
**Solution**: 
1. Remove `http://localhost:3000` from Supabase redirect URLs
2. Ensure tunnel URL is in the redirect URLs list
3. Clear Supabase client cache

#### Issue: "Invalid redirect URL" error
**Cause**: Generated URL is not in Supabase redirect URLs list
**Solution**: Add the generated URL (shown in console) to your Supabase redirect URLs

#### Issue: URL shows localhost even with tunnel
**Cause**: Supabase Site URL is set to localhost
**Solution**: Clear or change the Site URL in Supabase dashboard

### 7. Step-by-Step Fix

1. **Start Expo with tunnel**:
   ```bash
   npx expo start --tunnel
   ```

2. **Check console logs** when testing magic link to see generated URL

3. **Copy the generated URL** from console (e.g., `exp://u3m58lo-serendipitytech-8081.exp.direct/auth/callback`)

4. **Add URL to Supabase**:
   - Go to Supabase dashboard
   - Authentication > URL Configuration
   - Add the URL to "Redirect URLs" list

5. **Remove any localhost URLs** from the redirect URLs list

6. **Test again** - the magic link should now use the correct tunnel URL

### 8. Verification

After fixing, you should see:
- ✅ Console shows tunnel URL: `exp://xxx.exp.direct/auth/callback`
- ✅ Magic link email contains tunnel URL
- ✅ Clicking magic link opens your app
- ✅ Authentication completes successfully

### 9. Production Considerations

For production builds:
- Use `expo-checkin://auth/callback` as redirect URL
- Ensure your app's custom scheme is properly configured
- Test with actual production build, not Expo Go

### 10. Still Having Issues?

If you're still having problems:

1. **Check the exact error message** in the magic link email
2. **Verify the generated URL** in console logs
3. **Confirm Supabase configuration** matches the generated URL
4. **Test with a fresh Supabase project** if needed
5. **Check Expo CLI version** - ensure you're using a recent version

The key is ensuring that the URL generated by `Linking.createURL('/auth/callback')` exactly matches one of the URLs in your Supabase redirect URLs list.
